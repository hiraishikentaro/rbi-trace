# RBI::Trace

[![Gem Version](https://badge.fury.io/rb/rbi-trace.svg)](https://badge.fury.io/rb/rbi-trace)
[![Ruby](https://github.com/yourusername/rbi-trace/workflows/Ruby/badge.svg)](https://github.com/yourusername/rbi-trace/actions)
[![codecov](https://codecov.io/gh/yourusername/rbi-trace/branch/main/graph/badge.svg)](https://codecov.io/gh/yourusername/rbi-trace)

RBI::Trace is a Ruby gem that automatically generates RBI (Ruby Interface) files from Ruby source code. This tool helps create type signature files for Sorbet, Ruby's static type checker, by analyzing your codebase and extracting method signatures, class definitions, and module structures.

## Features

- ðŸ” **Automatic Analysis**: Analyzes Ruby code to extract class, module, and method structures
- ðŸ“ **RBI Generation**: Generates RBI files compatible with Sorbet type checker
- ðŸš€ **Fast Processing**: Efficient AST parsing using Prism for high-performance analysis
- ðŸ› ï¸ **CLI Support**: Easy command-line interface for batch processing
- ðŸ“Š **Detailed Output**: Comprehensive logging and verbose output options
- ðŸŽ¯ **Type-Safe**: Built with Sorbet runtime for enhanced reliability

## Installation

Add this line to your application's Gemfile:

```ruby
gem 'rbi-trace'
```

And then execute:

```bash
$ bundle install
```

Or install it yourself as:

```bash
$ gem install rbi-trace
```

## Usage

### Command Line Interface

```bash
# Process a single file
$ rbi-trace lib/my_class.rb

# Process a directory recursively
$ rbi-trace -r lib/

# Specify output directory
$ rbi-trace -o sorbet/rbi lib/

# Verbose output
$ rbi-trace -v lib/my_class.rb

# Process multiple files
$ rbi-trace lib/user.rb lib/post.rb lib/comment.rb
```

### Command Line Options

- `-o, --output DIR`: Specify output directory (default: `rbi`)
- `-r, --recursive`: Process directories recursively
- `-v, --verbose`: Enable verbose output
- `-h, --help`: Show help message
- `--version`: Show version

### Programmatic Usage

```ruby
require 'rbi/trace'

# Create parser and generator instances
parser = RBI::Trace::Parser.new
generator = RBI::Trace::Generator.new

# Parse a Ruby file
ast = parser.parse_file('lib/my_class.rb')

# Generate RBI content
rbi_content = generator.generate(ast)

# Write to file
File.write('rbi/my_class.rbi', rbi_content)
```

### Advanced Usage

```ruby
require 'rbi/trace'

# Configure parser options
parser = RBI::Trace::Parser.new(
  include_private: false,
  include_protected: true,
  strict_mode: true
)

# Configure generator options
generator = RBI::Trace::Generator.new(
  typed_level: 'strong',
  include_comments: true,
  sort_methods: true
)

# Process multiple files
files = Dir.glob('lib/**/*.rb')
files.each do |file|
  ast = parser.parse_file(file)
  rbi_content = generator.generate(ast)

  output_path = file.gsub('lib/', 'rbi/').gsub('.rb', '.rbi')
  FileUtils.mkdir_p(File.dirname(output_path))
  File.write(output_path, rbi_content)
end
```

## Examples

### Input (Ruby File)

```ruby
# lib/user.rb
class User
  attr_reader :name, :email
  attr_accessor :active

  def initialize(name, email)
    @name = name
    @email = email
    @active = true
  end

  def full_name
    "#{@name}"
  end

  def self.find_by_email(email)
    # Implementation...
  end

  def self.create(attributes = {})
    # Implementation...
  end

  private

  def validate_email
    # Implementation...
  end

  protected

  def normalize_name
    # Implementation...
  end
end
```

### Output (RBI File)

```ruby
# typed: strong
# frozen_string_literal: true

# This file was generated by rbi-trace
# Do not modify it manually

class User
  sig { returns(T.untyped) }
  attr_reader :name

  sig { returns(T.untyped) }
  attr_reader :email

  sig { returns(T.untyped) }
  attr_accessor :active

  sig { params(name: T.untyped, email: T.untyped).void }
  def initialize(name, email); end

  sig { returns(T.untyped) }
  def full_name; end

  sig { params(email: T.untyped).returns(T.untyped) }
  def self.find_by_email(email); end

  sig { params(attributes: T.untyped).returns(T.untyped) }
  def self.create(attributes = {}); end

  private

  sig { returns(T.untyped) }
  def validate_email; end

  protected

  sig { returns(T.untyped) }
  def normalize_name; end
end
```

## Key Features

### 1. Comprehensive Ruby Analysis

- Supports all Ruby language constructs
- Handles class inheritance and module inclusion
- Processes singleton methods and class methods
- Analyzes method parameters and default values

### 2. Sorbet Integration

- Generates type signatures compatible with Sorbet
- Supports various typed levels (ignore, false, true, strict, strong)
- Includes proper `sig` annotations
- Handles T.untyped for gradual typing

### 3. Flexible Configuration

- Customizable output formatting
- Optional inclusion of private/protected methods
- Configurable comment generation
- Method sorting options

### 4. Performance Optimized

- Uses Prism parser for fast AST generation
- Efficient memory usage for large codebases
- Parallel processing support for multiple files
- Incremental processing capabilities

## Development

After checking out the repo, run:

```bash
$ git clone https://github.com/yourusername/rbi-trace.git
$ cd rbi-trace
$ bundle install
```

### Running Tests

```bash
$ bundle exec rspec
```

### Code Quality

```bash
$ bundle exec rubocop
```

### Development Tasks

```bash
# Setup development environment
$ bundle exec rake dev:setup

# Run all quality checks
$ bundle exec rake dev:check

# Generate RBI files for examples
$ bundle exec rake rbi:examples

# Run performance benchmarks
$ bundle exec rake benchmark
```

## Contributing

Bug reports and pull requests are welcome on [GitHub](https://github.com/yourusername/rbi-trace).

1. Fork the repository
2. Create your feature branch (`git checkout -b my-new-feature`)
3. Commit your changes (`git commit -am 'Add some feature'`)
4. Push to the branch (`git push origin my-new-feature`)
5. Create a Pull Request

## Requirements

- Ruby >= 3.2.0
- Sorbet runtime
- Prism parser

## License

The gem is available as open source under the terms of the [MIT License](https://opensource.org/licenses/MIT).

## Related Projects

- [Sorbet](https://sorbet.org/) - A fast, powerful type checker designed for Ruby
- [RBI](https://github.com/Shopify/rbi) - A Ruby library for manipulating RBI files
- [Tapioca](https://github.com/Shopify/tapioca) - A tool for generating RBI files for gems
- [Steep](https://github.com/soutaro/steep) - Another static type checker for Ruby

## Acknowledgments

This project was inspired by the need for better tooling in the Ruby static typing ecosystem. Special thanks to the Sorbet team and the Ruby community for their contributions to static typing in Ruby.
